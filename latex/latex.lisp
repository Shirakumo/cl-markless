(defpackage #:cl-markless-latex
  (:nicknames #:org.shirakumo.markless.latex)
  (:use #:cl #:org.shirakumo.markless)
  (:shadow #:output)
  (:local-nicknames
   (#:components #:org.shirakumo.markless.components))
  (:shadowing-import-from #:org.shirakumo.markless #:debug)
  (:export
   #:latex
   #:output))
(in-package #:org.shirakumo.markless.latex)

(defclass latex (output-format)
  ((processor :initarg :processor :initform "lualatex" :accessor processor)
   (documentclass :initarg :documentclass :initform "[a4paper,12pt]{article}" :accessor documentclass)
   (preamble :initarg :preamble :initform NIL :accessor preamble)
   (verbose :initarg :verbose :initform NIL :accessor verbose)))

(defun output (markless target &rest args)
  (etypecase markless
    (pathname
     (let ((*default-pathname-defaults* (make-pathname :name NIL :type NIL :defaults markless)))
       (apply #'output (cl-markless:parse markless T) target args)))
    (string
     (apply #'output (cl-markless:parse markless T) target args))
    (components:component
     (output-component markless target (apply #'make-instance 'latex args)))))

(defmacro define-tex-output (class &body body)
  (destructuring-bind (class . args) (if (listp class) class (list class))
    `(defmethod output-component ,@args ((component ,class) (stream stream) (format latex))
       (macrolet ((texfun (name &rest args)
                    `(format stream ,(format NIL "\\~a狺撖祜镳骘狎轭狎珞泔祆邈豉疱汜箦狎ㄣ镱幄簌礅镬篝蜷铉滹黝汜箦狎绌ㄔ狎绌┅ㄥ豉疱汜箦钺礤簌礅镬篝蜷铉滹黝汜箦钺礤┅篝蜷铉钺礤┅括祜镳骘狎轭狎珞麒孱ㄣ镱箴狎绌泔祆邈狎绌┅翦骢睢钺礤蝈篝狎珞啜痱镧ㄦ蝈箬扉铄篝蝈犴翦骢钺礤泪蜱螬翦蝠蜷篝蝈犴┅┅ㄦ戾è秕麴豸ㄣ镯痫铄铘秕麴豸泔眇镱孱泔眇镱孱篝蝈犴骘蝽狒┅ㄤ邈灬蝈ㄩ珙矧徕戾＇秕麴豸┅棱镤┅┅ㄤ彐礤翳镤秕麴豸泔眇镱孱è泔眇镱孱泔眇镱孱趔候镲舡泔眇镱孱舂疳翳疳翳钺礤ㄦ矧磲灬翦┅ㄣ镱è篝蜷铉痄姊疳翳钺礤豉疱疳翳┅蹰镳瑚轸璀翦眇矧狎骈戾ê疳翳钺礤翦后趄遽篝蝈犴呼疱Ⅳ屮秕麴豸泔眇镱孱泔眇镱孱篝蝈犴骘蝽狒ㄣ祜箦篝蝈犴蹰镳候躅痱镧蜥扉篝痱镢弩箫骘蝽狒箬屐飙弩汜疱骈戾扉铄弪蝻颌栳祠镱弪蝻颌轭翦蜥泗轱罱铒铙麸痦镤澧ㄦ矧磲紊觑忸犴褰幄疳翳钺礤钺礤疳翳┅ㄦ矧磲紊秕麴豸溟蝈泗矧浸幄蹰镳侯狒轹瀛钺礤篝蜷铉磲脲疳翳钺礤侯犴紊呼疱紊轰彐狨祠疳翳┅蹰镳侯狒轹瀛钺礤篝蜷铉翦┅猴豸瘐麒孱鲥蜮矬骘蝽狒弪蝻颦秕麴豸哄蝌矧秕麴豸麒孱鲥蜮矬骘蝽狒弪蝻颦秕麴豸┅┅ㄔㄣ犰飙铄舡礤翳镤┅┅ㄤ彐磲泸溴骈铄翦磲ㄣ镯痫铄铘翦骢蝈篝狎珞啜溴骈铄翦秕麴豸泔眇镱孱翦骢翦骢泪蜱螬黩轸瀛汨狎＼篝蝈犴ㄣ犰飙铄舡礤翳镤黩轸瀛汨狎＼篝蝈犴┅ㄤ彐轭瀛翦秕麴豸篝蜷铉祜镳骘汨狎徙蝻篌泔眇镱孱滹ㄣ狍汨狎è＼＼＼＼＼＼＼黩轸瀛汨狎＼篝蝈犴黩轸瀛汨狎汨狎篝蝈犴┅ǎ荥翦骢翦翎筱殚糸熹┅ǎ苻翦骢翦翎筱殚汩蜚蹴┅ǎ苘翦骢翦翕徙塍灬箬┅ㄔ黩轸瀛汨狎汨狎篝蝈犴┅┅ㄤ彐礤翳镤秕麴豸泔眇镱孱è泔眇镱孱泔眇镱孱趔恒镯痫铄铘篝蝈犴篝蝈犴ㄦ矧磲灬翦┅ㄤ彐礤翳镤秕麴豸泔眇镱孱è泔眇镱孱泔眇镱孱趔吼狎孱舡泔眇镱孱舂篝蝈犴篝蝈犴ㄦ矧磲灬翦┅祜镳骘汨殪徙蝻篌ㄣ镯痫铄铘蠛汨殪潋孱泔眇镱孱舂滹秕麴豸泔眇镱孱汨殪篝蝈犴骘蝽狒┅ㄤ彐躅筱犷豉疱ㄣ镯痫铄铘豉疱灬忮祗è筱犷ㄣ镯痫铄铘麒孱豉疱泔眇镱孱豉疱蝈趱蝾骝镯筱犷豉疱冤麒孱豉疱泔眇镱孱с镯痫铄铘蠛疳蝈铘泔眇镱孱舂祜镳骘汨殪徙蝻篌ㄣ镯痫铄铘蠛汨殪潋孱泔眇镱孱舂滹筱犷汨殪洎┅麒孱豉疱泔眇镱孱Ж矧泔眇镱孱趔恒镯痫躅泔眇镱孱趔哄礅邃┅祜镳骘汨殪轭ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂滹筱犷汨殪洎┅┅筱犷泔眇镱孱舂┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔候镲舡泔眇镱孱ㄦ矧磲篝蝈犴④茕镢蹴孱翥灬篌幄ㄤ镢蹴孱翥灬篌骘蝽狒┅翦骢睢躞屦徙脶珏埘翩篙轭瘐翦钽麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛屙忮洎翦骢睢躞屦徙脶珏扉篝轭珞┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛骒镝舡镳糸镱翦骢睢躞屦徙脶珏骒镝翩祠┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛轫徵濠翦骢睢躞屦徙脶珏珧狃栝泺┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛扉篝翦骢睢躞屦徙脶珏孱蹴轸屙┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛骘雉铒翦翦骢睢躞屦徙脶珏珈矬筢蜷弩┅麒孱筱犷豉疱泔眇镱孱Ж矧泔眇镱孱趔乎蜢泔眇镱孱趔红轭氕镳糸镱┅翦骢睢躞屦徙脶珏棂疱蝌彐┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛骘铘镳糸镱翦骢睢躞屦徙脶珏骘铘箴邈┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛泔祜颦镳糸镱翦骢睢躞屦徙脶珏泔祜螨┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛篝蜷脲翳蝻蹒瑭翦骢睢躞屦徙脶珏汜钽屐┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛忪镢腭躏翦翦骢睢躞屦徙脶珏泱聃雉弩┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛泔溴忪镢氅翦骢睢躞屦徙脶珏黹铘邃┅麒孱筱犷豉疱泔眇镱孱с镯痫铄铘蠛犰殓瞟翦骢睢躞屦徙脶珏蜥珑邃插┅ㄦ矧磲篝蝈犴累狺蔺ア痱遽礅戾骘蝽狒┅麒孱ㄣ镯痫铄铘蠛狨翳矧泔眇镱孱舂黩轸瀛汨狎＼篝蝈犴翦骢狨翳矧ㄣ镯痫铄铘蠛狨翳矧泔眇镱孱舂┅翦骢睢忮玳滹沲礤铘ㄣ犰飙铄舡礤翳镤翦骢睢孱滹沲礤铘┅ㄤ彐轭瀛翦磲泔眇镱孱趔洪翎扉翦糸舂ㄤ彐轭瀛翦磲泔眇镱孱趔衡镬翦翕姗ㄤ彐轭瀛翦磲泔眇镱孱趔乎钿弪扉铄躅溴蜢轭濠ㄤ彐轭瀛翦磲泔眇镱孱趔后趄殡弭栩秕玷汜钽屐ㄤ彐轭瀛翦磲泔眇镱孱趔恒镤翦趑舂ㄤ彐轭瀛翦磲泔眇镱孱趔后踱翦翦趔踱筱蜷痿ㄤ彐轭瀛翦磲泔眇镱孱趔后躔弪翦翦趔躔弪筱蜷痿ㄤ彐轭瀛翦磲泔眇镱孱趔乎蜢躜飑ㄤ彐轭瀛翦磲泔眇镱孱趔红徕屐灬忮飑ㄤ彐轭瀛翦磲泔眇镱孱趔侯鬻扉铄铄黛轭濠ㄤ彐轭瀛翦磲泔眇镱孱趔哄瞽溽箬翦翦钿狍瑭ㄤ彐轭瀛翦磲泔眇镱孱趔哄憝溽箬翦翦礓狍瑭ㄤ彐轭瀛翦磲泔眇镱孱趔烘镲纛雉骘雉铒翦翦ㄣ镯痫铄铘蠛翎蜱弭泔眇镱孱舂荸ㄤ彐轭瀛翦磲泔眇镱孱趔烘镲纛雉瀛蝈驽蝈钽骘雉铒翦磲螂ㄣ镯痫铄铘蠛翎蜱弭泔眇镱孱舂荸ㄤ彐轭瀛翦磲泔眇镱孱趔鸿矧辁镱翎飙蝓戾栩蹯彐殪飑ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔恒镯礤铘ㄦ矧磲篝蝈犴Ε狺アㄣ镯痫铄铘蠛翦泔眇镱孱舂┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔鸿遽溴ㄦ矧磲篝蝈犴ボ荥坫栳痿弪惑邈糸镱惑踱箦泗轱铪惑踱篚怏邈糸镱火狎徵蜥痂惑踱疳蜥珧狃棹蓰ㄣ镯痫铄铘蠛溴痿泔眇镱孱舂ㄣ犰飙铄舡礤翳镤ㄦ矧磲篝蝈犴ア┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔吼狎徵蜥痂ㄦ矧磲篝蝈犴アㄣ犰飙铄舡礤翳镤ㄦ矧磲篝蝈犴ア┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔衡祜汶聃雉瀛桢徜弪ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔衡祜汶聃雉翦骢翦赳躏翦郓麒孱ㄣ镯痫铄铘蠛箫躜沐泔眇镱孱舂祜镳骘汨殪徙蝻篌ㄣ镯痫铄铘蠛汨殪潋孱ㄣ镯痫铄铘蠛箫躜沐泔眇镱孱舂滹ㄣ飙磲螂戾篌猴豸瘐汨殪洎┅ㄦ矧磲篝蝈犴⑤アㄣ犰飙铄舡礤翳镤ㄦ矧磲篝蝈犴ア┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔乎铒蜾弪邃扉篝翦骢睢忮玳铥轸屙辁妪ㄣ犰飙铄舡礤翳镤翦骢睢孱潲轸屙辁妪┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔猴蜾弪邃扉篝翦骢睢忮玳铥孱蹴弪狒妪ㄣ犰飙铄舡礤翳镤翦骢睢孱潲孱蹴弪狒妪┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔红轶舡轸屙ㄦ矧磲篝蝈犴苘轸屙ㄣ犰飙铄舡礤翳镤┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔猴蜾弪邃扉篝轸屙ㄦ矧磲篝蝈犴④荏弭泔躅翦螓孱蹴辇潺ㄣ镯痫铄铘蠛铛礅弪泔眇镱孱舂ㄣ犰飙铄舡礤翳镤┅ㄤ彐躅趄犷箪狒瀛躅轸箝邃戾è箝ㄣ镯痫铄铘蠛箝箝邃┅ㄣ狍ㄣ镯痫铄铘蠛躅轸箝邃ê瘌ㄦ矧磲紊骛簪箝濠êㄦ矧磲紊姊í爱氨箝濠┅ㄔㄦ矧磲紊纩狺箝ㄣ镯痫铄铘蠛躅轸箝邃┅┅┅ㄤ彐轭瀛翦秕麴豸ㄣ镯痫铄铘蠛屙忮横蝻躅洎戾è骒镝ㄦ轭с镯痫铄铘蠛骒镝舡镳糸镱ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂弘妁＇豉疱镦┅鏖漪ㄦ轭с镯痫铄铘蠛鏖漪璀镳糸镱ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂弘妁＇豉疱镦┅ㄩ骒镝翦骢睢忮玳骒镝糸铉骈珲蝈ㄥ汜箦ㄣ镯痫铄铘蠛溟蝈泗轱骒镝舂ê戾骠㈧ê蜷玷Ⅱ┅趄犷箪狒瀛躅轸鏖漪瑭翦骢睢忮玳骈珲蝈③容┅翦骢睢沐铘弪轭绌ㄣ犰飙铄舡礤翳镤祜镳骘镳糸镱轭ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂滹豉疱汜箦镳糸镱ㄣ镯痫铄铘蠛汜痿轱瞽镳糸镱翦骢汜痿轱ㄣ飙磲螂戾篌猴豸瘐镳糸镱ㄦ矧磲篝蝈犴┅ㄣ镯痫铄铘蠛灬忮飙镳糸镱翦骢睢灬忮ㄣ镯痫铄铘蠛翎蜱弭镳糸镱┅┅ㄩ骒镝翦骢睢孱骒镝糸铉骈珲蝈翦骢睢孱骈珲蝈┅┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔哄礅邃翦骢睢躜ㄣ镯痫铄铘蠛翎蜱弭泔眇镱孱舂┅ㄤ彐躅骈戾屮翦铙轱篝蜷铉戾è滹痫箝糸镱＼篝蜷铉烘蝻憝孱冤┅麒孱滹篚怏羼篝蜷铉ū滹舂┅┅ㄤ彐躅磲忮汜汨翎蜱弭骘蝽狒ㄣ镱è矧篝狎趔鏖翳㈣趑鸷翎蜱弭篝狎趔鏖翳㈣趑痼函翎蜱弭┅戾è翦眇鏖翳秕麴豸麸篝蜷铉秕舂黩轸瀛篝蜷铉繇鸠磲螂戾篌灬翦繇瓠秕舂祜镳骘汨狎徙蝻篌翎蜱弭滹ㄩㄦ轭汨狎⒑化苘堍季扣蓰Δィ蔻黩轸瀛汨狎＼秕舂黩轸瀛汨狎汨狎秕舂┅┅ㄥ铙躜瀛溟蝈泗矧殄蟓屮轶翦眇躅戾篌痱镡瀛骈戾翦眇麒孱鲥蜮矬骘蝽狒ㄦ矧磲溴怩绛轱娘黝祜徜轭岙ア翎蜱弭┅蹰镳候躅痱镧蜥扉篝沲蜢姊铫翦眇翎蜱弭┅躅戾篌ㄦ轭ㄦ殪瀛屮翦铙轱翎蜱弭（牮牮彗痤屦痄姗呼弩＇篝蜷铉羼踽飑戾舄è屮趔篝蜷铉蜷玷舡趄轫Ж＼涕铄驽邃＼义趱蝾蹰镳候躅痱镧蜥扉篝㈡殪澧猗屮翦铙轱睥翦眇猴豸瘐后趄轭绌┅ㄥㄦ轵篝箴扉舡篝蜷铉屮趔＼┅铄ㄦ矧磲紊岙幄翦眇屮舂┅蹰镳恒镳骈戾翦眇铄鳗箦翩翦眇铄鳗┅翦眇┅ㄔ翎蜱弭┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔洪磲珏ㄨ犷潇弪汜箦戾è鏖漪ㄦ轭с镯痫铄铘蠛鏖漪璀镳糸镱ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂弘妁＇豉疱镦┅ㄨ彘玷ㄦ轭с镯痫铄铘蠛桢殓梏镳糸镱ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂弘妁＇豉疱镦┅翎蜱弭磲忮汜汨ㄣ镯痫铄铘蠛翎蜱弭泔眇镱孱舂骘蝽狒┅翦骢睢轭沆蹁彗蜥痂殂ㄩ鏖漪ㄦ矧磲紊Ⅶ殇翳浸幄趄犷箪狒瀛躅轸鏖漪瑭ㄦ矧磲紊Ⅶ殇翳桨杠翦赭殇翳┅ㄦ矧磲紊累桢殓梏浸狺茛麒孱桢殓梏趄犷箪狒瀛躅轸桢殓梏┅ㄩ溴铘轸翎蜱弭┅ㄥ蝌矧īㄣ犰飙铄舡礤翳镤┅┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔恒镤瀛忪镢翦骢睢忮玳黹铘邃垅蝈犭扉铄筝ㄣ镯痫铄铘蠛灬铉踽珏泔眇镱孱舂黩轸瀛篝蜷铉ㄣ镯痫铄铘蠛翦泔眇镱孱舂篝蝈犴翦骢睢孱黹铘邃┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔横扉珙戾è孱ㄥ汜箦ㄣ镯痫铄铘蠛犰殓铐孱泔眇镱孱舂ê戾骠㈡祯箬戾骠ê蜷玷㈡祯箬蜷玷簪ê沐铘弪沐铘弪ê牾篝殒㈥躞糸纟┅┅翦骢睢忮玳ㄩ溴铘轸孱雯ㄣ犰飙铄舡礤翳镤翦骢睢孱ㄩ溴铘轸孱雯┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔恒镯痫躅祜镳骘镳糸镱轭ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂滹ㄣ飙磲螂戾篌猴豸瘐镳糸镱┅ㄣ犰飙铄舡礤翳镤祜镳骘镳糸镱轭ㄣ镯痫铄铘蠛镳糸镱泔眇镱孱舂滹ㄦ矧磲篝蝈犴┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔洪翎扉悱镳糸镱翦骢翦糸┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔衡镬洵镳糸镱翦骢翦翕┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔乎钿弪扉铄镳糸镱翦骢躅溴蜢轭┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔后趄殡弭栩秕玷镳糸镱翦骢汜钽屐┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔后痫殪弪镳糸镱翦骢翦翥镬矧忪徙臊┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔烘镱舡镳糸镱ㄦ矧磲篝蝈犴Ⅺ翦骢骘铘驷黹禊ㄣ镯痫铄铘蠛骘铘驷黹禊泔眇镱孱舂翦骢箦戾泗骘铘┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔恒镬矧镳糸镱翦骢翦翥镬矧垡锹ㄣ镯痫铄铘蠛蝈泔眇镱孱舂ㄣ镯痫铄铘蠛珧邋泔眇镱孱舂ㄣ镯痫铄铘蠛忪蹂泔眇镱孱舂┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔后辁瀛镳糸镱ㄦ矧磲篝蝈犴Ⅺ翦骢骘铘箝趄犷箪狒瀛躅轸泔眇镱孱舂趄犷箪狒瀛躅轸泔眇镱孱舂翦骢箦戾泗骘铘┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔红轭氕镳糸镱翦骢栩彐ㄣ镯痫铄铘蠛翎蜱弭泔眇镱孱舂┅ㄤ彐轭瀛翦秕麴豸泔眇镱孱趔洪铘弪钺飙扉铍镳糸镱翦骢棂疱蝌彐ㄣ镯痫铄铘蠛翎蜱弭泔眇镱孱舂┅ㄤ彐礤翳镤秕麴豸泔眇镱孱è蜥泔眇镱孱趔候狩篝蝈犴篝蝈犴ㄦ矧磲灬翦┅麒孱矧篝蜷铉羼踽㈧狒屮ㄣ镯痫铄铘蠛翎蜱弭蜥鳗篝蜷铉羼踽Ⅳ屮ㄣ镯痫铄铘蠛翎蜱弭蜥鳗┅黩轸瀛篝蜷铉ㄣ镯痫铄铘蠛翦蜥鳗篝蝈犴┅